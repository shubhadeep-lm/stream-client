<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Streaming Client â€¢ HLS Player</title>
  <link rel="preconnect" href="https://cdn.jsdelivr.net" />
  <style>
    :root { color-scheme: light dark; }
    body { margin: 0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, 'Helvetica Neue', Arial, 'Noto Sans', 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol', 'Noto Color Emoji'; background: #0b1020; color: #e8ecf1; }
    .wrap { max-width: 960px; margin: 32px auto; padding: 0 16px; }
    h1 { font-size: 20px; font-weight: 600; letter-spacing: 0.2px; margin: 0 0 16px; color: #e3f2fd; }
    .card { background: #11182f; border: 1px solid #1d2a4d; border-radius: 12px; padding: 16px; box-shadow: 0 6px 16px rgba(0,0,0,0.25); }
    .row { display: grid; grid-template-columns: 1fr 1fr auto; gap: 12px; align-items: end; margin-bottom: 12px; }
    label { font-size: 12px; color: #9fb3c8; display: block; margin-bottom: 6px; }
    input, select, button { height: 40px; border-radius: 10px; border: 1px solid #2b3c66; background: #0f152b; color: #e8ecf1; padding: 0 12px; }
    input::placeholder { color: #6f7fa1; }
    button { background: linear-gradient(135deg, #3a7bd5 0%, #00d2ff 100%); border: none; color: #081226; font-weight: 600; cursor: pointer; padding: 0 16px; }
    button:hover { filter: brightness(1.05); }
    .video-box { aspect-ratio: 16/9; background: #0a0f22; border: 1px solid #1d2a4d; border-radius: 12px; overflow: hidden; }
    video { width: 100%; height: 100%; background: black; display: block; }
    .meta { margin-top: 10px; display: flex; gap: 12px; flex-wrap: wrap; font-size: 12px; color: #a8bbd2; }
    .err { margin-top: 8px; color: #ff8a80; font-size: 12px; min-height: 16px; }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>HLS Player</h1>
    <div class="card">
      <div class="row">
        <div>
          <label for="base">Server Base URL</label>
          <input id="base" type="text" placeholder="http://localhost:4001" />
        </div>
        <div>
          <label for="job">Job ID</label>
          <input id="job" type="text" placeholder="e.g. 1693300000000_abcd12" />
        </div>
        <div>
          <button id="play">Play</button>
        </div>
      </div>
      <div class="row" style="grid-template-columns: 1fr 1fr;">
        <div>
          <label for="quality">Quality</label>
          <select id="quality">
            <option value="auto" selected>Auto</option>
          </select>
        </div>
        <div>
          <label for="url">Or direct .m3u8 URL</label>
          <input id="url" type="text" placeholder="http://localhost:4001/assets/video/<jobId>/master.m3u8" />
        </div>
      </div>
      <div class="video-box">
        <video id="video" controls playsinline></video>
      </div>
      <div class="controls" style="display:grid;grid-template-columns:auto auto 1fr auto auto auto auto auto;gap:10px;align-items:center;margin:12px 0;">
        <button id="togglePlay">Play</button>
        <button id="mute">Mute</button>
        <input id="volume" type="range" min="0" max="1" step="0.01" value="1" title="Volume" />
        <input id="seek" type="range" min="0" max="0" step="0.1" value="0" title="Seek" />
        <span id="time" style="font-variant-numeric: tabular-nums; font-size:12px; color:#a8bbd2;">00:00 / 00:00</span>
        <select id="rate" title="Playback speed">
          <option value="0.5">0.5x</option>
          <option value="0.75">0.75x</option>
          <option value="1" selected>1x</option>
          <option value="1.25">1.25x</option>
          <option value="1.5">1.5x</option>
          <option value="2">2x</option>
        </select>
        <button id="pip" title="Picture-in-Picture">PiP</button>
        <button id="fs" title="Fullscreen">Fullscreen</button>
        <label style="display:flex;align-items:center;gap:6px;justify-self:end;">
          <input id="stats" type="checkbox" /> Stats
        </label>
      </div>
      <pre id="statsBox" style="display:none;background:#0a0f22;border:1px solid #1d2a4d;border-radius:8px;padding:8px;margin:0;white-space:pre-wrap;word-break:break-word;font-size:12px;color:#bcd;">
      </pre>
      <div class="meta">
        <span id="state">Idle</span>
        <span id="info"></span>
      </div>
      <div id="error" class="err"></div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
  <script>
    const $ = (id) => document.getElementById(id);
    const video = $('video');
    const playBtn = $('play');
    const base = $('base');
    const job = $('job');
    const url = $('url');
    const q = $('quality');
    const state = $('state');
    const info = $('info');
    const errorBox = $('error');

    let hls = null;

    // Controls
    const togglePlayBtn = $('togglePlay');
    const muteBtn = $('mute');
    const volumeSlider = $('volume');
    const seekSlider = $('seek');
    const timeLabel = $('time');
    const rateSelect = $('rate');
    const pipBtn = $('pip');
    const fsBtn = $('fs');
    const statsChk = $('stats');
    const statsBox = $('statsBox');
    const videoBox = document.querySelector('.video-box');

    let statsTimer = null;

    const fmt = (s) => {
      if (!isFinite(s)) return '00:00';
      const sign = s < 0 ? '-' : '';
      s = Math.max(0, Math.floor(Math.abs(s)));
      const hh = Math.floor(s / 3600);
      const mm = Math.floor((s % 3600) / 60);
      const ss = s % 60;
      const pad = (n) => String(n).padStart(2, '0');
      return (hh ? `${pad(hh)}:` : '') + `${pad(mm)}:${pad(ss)}`;
    };

    function updateTimeUI() {
      const cur = video.currentTime || 0;
      const dur = isFinite(video.duration) ? video.duration : 0;
      timeLabel.textContent = `${fmt(cur)} / ${fmt(dur)}`;
      if (!seekSlider.dragging) {
        seekSlider.max = String(dur || 0);
        seekSlider.value = String(cur || 0);
      }
    }

    video.addEventListener('timeupdate', updateTimeUI);
    video.addEventListener('durationchange', updateTimeUI);
    video.addEventListener('loadedmetadata', updateTimeUI);

    // Play/Pause
    function syncPlayBtn() { togglePlayBtn.textContent = video.paused ? 'Play' : 'Pause'; }
    video.addEventListener('play', syncPlayBtn);
    video.addEventListener('pause', syncPlayBtn);
    togglePlayBtn.addEventListener('click', () => { video.paused ? video.play() : video.pause(); });

    // Volume & Mute
    function syncMuteUI() { muteBtn.textContent = video.muted || video.volume === 0 ? 'Unmute' : 'Mute'; }
    volumeSlider.addEventListener('input', () => { video.volume = parseFloat(volumeSlider.value); if (video.volume > 0) video.muted = false; syncMuteUI(); });
    muteBtn.addEventListener('click', () => { video.muted = !video.muted; if (video.muted) volumeSlider.value = '0'; else if (parseFloat(volumeSlider.value) === 0) volumeSlider.value = '1'; syncMuteUI(); });

    // Seek
    seekSlider.addEventListener('input', () => { seekSlider.dragging = true; updateTimeUI(); });
    seekSlider.addEventListener('change', () => { const t = parseFloat(seekSlider.value); if (isFinite(t)) video.currentTime = t; seekSlider.dragging = false; });

    // Playback rate
    rateSelect.addEventListener('change', () => { const r = parseFloat(rateSelect.value); if (!Number.isNaN(r)) video.playbackRate = r; });

    // Fullscreen
    fsBtn.addEventListener('click', async () => {
      try {
        if (document.fullscreenElement) await document.exitFullscreen();
        else if (videoBox?.requestFullscreen) await videoBox.requestFullscreen();
      } catch {}
    });

    // Picture in Picture
    pipBtn.addEventListener('click', async () => {
      try {
        if (document.pictureInPictureElement) await document.exitPictureInPicture();
        else if (document.pictureInPictureEnabled && video.requestPictureInPicture) await video.requestPictureInPicture();
      } catch {}
    });

    // Stats
    function getBufferLen() {
      if (hls && typeof hls.bufferInfo === 'function') {
        const bi = hls.bufferInfo(video.currentTime, 0.5);
        return bi?.len ?? 0;
      }
      const buf = video.buffered;
      for (let i = 0; i < buf.length; i++) {
        const start = buf.start(i), end = buf.end(i);
        if (video.currentTime >= start && video.currentTime <= end) return end - video.currentTime;
      }
      return 0;
    }

    function updateStats() {
      const levelIndex = hls?.currentLevel ?? -1;
      const level = hls?.levels?.[levelIndex];
      const br = level?.bitrate ? Math.round(level.bitrate / 1000) + ' kbps' : 'auto';
      const res = level ? `${level.width || ''}x${level.height || ''}` : 'auto';
      const q = (video.getVideoPlaybackQuality && video.getVideoPlaybackQuality()) || {};
      const dropped = q.droppedVideoFrames ?? q.droppedFrames ?? 'n/a';
      const total = q.totalVideoFrames ?? q.totalFrames ?? 'n/a';
      const bufLen = getBufferLen().toFixed(2);
      statsBox.textContent = `Level: ${levelIndex} (${res}, ${br})\nBuffer: ${bufLen}s\nFrames: ${dropped}/${total}`;
    }

    statsChk.addEventListener('change', () => {
      const on = statsChk.checked;
      statsBox.style.display = on ? 'block' : 'none';
      if (on) {
        if (statsTimer) clearInterval(statsTimer);
        statsTimer = setInterval(updateStats, 500);
      } else if (statsTimer) {
        clearInterval(statsTimer);
        statsTimer = null;
      }
    });

    function setError(msg) {
      errorBox.textContent = msg || '';
      if (msg) console.error(msg);
    }

    function setState(s) { state.textContent = s; }

    function cleanup() {
      if (hls) {
        hls.destroy();
        hls = null;
      }
      video.removeAttribute('src');
      video.load();
      q.innerHTML = '<option value="auto" selected>Auto</option>';
    }

    function buildUrl() {
      if (url.value.trim()) return url.value.trim();
      const b = (base.value.trim() || 'http://localhost:4001').replace(/\/$/, '');
      const j = job.value.trim();
      if (!j) return '';
      return `${b}/assets/videos/${encodeURIComponent(j)}/master.m3u8`;
    }

    function populateQualities() {
      if (!hls) return;
      const levels = hls.levels || [];
      // Reset keep Auto
      q.innerHTML = '<option value="auto" selected>Auto</option>';
      levels.forEach((lvl, i) => {
        const label = lvl.name || `${(lvl.height||0)}p @ ${(Math.round((lvl.bitrate||0)/1000))} kbps`;
        const opt = document.createElement('option');
        opt.value = String(i);
        opt.textContent = label;
        q.appendChild(opt);
      });
    }

    q.addEventListener('change', () => {
      if (!hls) return;
      if (q.value === 'auto') {
        hls.currentLevel = -1; // auto
      } else {
        const levelIndex = parseInt(q.value, 10);
        if (!Number.isNaN(levelIndex)) hls.currentLevel = levelIndex;
      }
    });

    playBtn.addEventListener('click', async () => {
      setError('');
      setState('Loading manifest...');
      const src = buildUrl();
      if (!src) {
        setError('Please provide a Job ID or direct .m3u8 URL.');
        setState('Idle');
        return;
      }

      cleanup();

      if (window.Hls && window.Hls.isSupported()) {
        hls = new window.Hls({
          // You may tune these for your environment
          maxMaxBufferLength: 60,
          backBufferLength: 30,
          capLevelToPlayerSize: true,
          enableWorker: true,
        });
        hls.on(window.Hls.Events.ERROR, (evt, data) => {
          console.warn('HLS.js error', data);
          if (data?.fatal) {
            switch (data.type) {
              case window.Hls.ErrorTypes.NETWORK_ERROR:
                setError('Network error, trying to recover...');
                hls.startLoad();
                break;
              case window.Hls.ErrorTypes.MEDIA_ERROR:
                setError('Media error, trying to recover...');
                hls.recoverMediaError();
                break;
              default:
                setError('Fatal error. Reloading...');
                hls.destroy();
                break;
            }
          }
        });
        hls.on(window.Hls.Events.MANIFEST_PARSED, (_, data) => {
          setState('Manifest parsed. Starting playback...');
          populateQualities();
          video.play().catch(() => {});
          const levels = (hls.levels||[]);
          if (levels.length) {
            const best = levels.reduce((a, b) => (b.height||0) > (a.height||0) ? b : a, levels[0]);
            info.textContent = `Best level: ${best.height||''}p @ ${Math.round((best.bitrate||0)/1000)} kbps`;
          } else { info.textContent = ''; }
        });
        hls.on(window.Hls.Events.LEVEL_SWITCHED, (_, data) => {
          const lvl = hls.levels?.[data.level];
          if (lvl) info.textContent = `Now: ${lvl.height||''}p @ ${Math.round((lvl.bitrate||0)/1000)} kbps`;
        });
        hls.attachMedia(video);
        hls.loadSource(src);
      } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
        // Safari and some browsers
        video.src = src;
        video.addEventListener('loadedmetadata', () => video.play());
      } else {
        setError('HLS is not supported in this browser.');
        setState('Idle');
        return;
      }
    });

    // Defaults for convenience
    base.value = 'http://localhost:4001';
  </script>
</body>
</html>
